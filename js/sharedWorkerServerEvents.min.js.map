{"version":3,"file":"sharedWorkerServerEvents.min.js","mappings":"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","sources":["webpack://cotonti/./src/serverEvents/driver/BaseServerEventsDriver.js","webpack://cotonti/./src/serverEvents/driver/ServerEventsSSEDriver.js","webpack://cotonti/./src/serverEvents/driver/ServerEventsAjaxDriver.js","webpack://cotonti/./src/serverEvents/driver/ServerEventsDriverFactory.js","webpack://cotonti/./src/serverEvents/sharedWorker.js"],"sourcesContent":["/**\r\n * Base server events driver\r\n * @package Cotonti\r\n * @copyright (c) Cotonti Team\r\n */\r\nexport class BaseServerEventsDriver extends EventTarget {\r\n    mode = 'production';\r\n\r\n    /**\r\n     * @type {string|null}\r\n     */\r\n    eventsUrl = null;\r\n\r\n    constructor(eventsUrl, mode = null) {\r\n        super();\r\n\r\n        if (mode !== null && mode !== '') {\r\n            this.mode = mode;\r\n        }\r\n        this.eventsUrl = eventsUrl;\r\n    }\r\n\r\n    init() { }\r\n\r\n    onEventTriggered(eventData) {\r\n        if (this.mode !== 'production') {\r\n            console.log('ServerEventsDriver: Server triggered event', eventData);\r\n        }\r\n\r\n        const event = new CustomEvent('event', {detail: eventData});\r\n        this.dispatchEvent(event);\r\n    }\r\n}","import {BaseServerEventsDriver} from \"./BaseServerEventsDriver\";\r\n\r\n/**\r\n * Server - Sent events driver\r\n * @package Cotonti\r\n * @copyright (c) Cotonti Team\r\n * @link https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events\r\n */\r\nexport class ServerEventsSSEDriver extends BaseServerEventsDriver {\r\n    /**\r\n     * @type {EventSource|null}\r\n     */\r\n    #eventSource = null;\r\n\r\n    init() {\r\n        if (this.#eventSource !== null) {\r\n            return;\r\n        }\r\n\r\n        if (this.mode !== 'production') {\r\n            console.log('init ServerEventsSSEDriver. ', this.eventsUrl);\r\n        }\r\n\r\n        const url = this.eventsUrl + '&ts=' + Date.now();\r\n        this.#eventSource = new EventSource(url);\r\n\r\n        if (this.mode !== 'production') {\r\n            this.#eventSource.onopen = function (event) {\r\n                console.log('ServerEventsSSEDriver connection is open');\r\n            };\r\n        }\r\n\r\n        this.#eventSource.onmessage = (event) => {\r\n            const eventData = JSON.parse(event.data);\r\n            if (eventData.data !== undefined && (typeof eventData.data === 'string') && eventData.data !== '') {\r\n                eventData.data = JSON.parse(eventData.data);\r\n            }\r\n            eventData.eventId = event.lastEventId;\r\n            this.onEventTriggered(eventData);\r\n        };\r\n\r\n        if (this.mode !== 'production') {\r\n            this.#eventSource.onerror = function (event) {\r\n                console.log('ServerEventsSSEDriver connection error');\r\n            }\r\n        }\r\n    }\r\n}","import {BaseServerEventsDriver} from \"./BaseServerEventsDriver\";\r\n\r\n/**\r\n * Server events ajax driver\r\n * @package Cotonti\r\n * @copyright (c) Cotonti Team\r\n */\r\nexport class ServerEventsAjaxDriver extends BaseServerEventsDriver {\r\n    #timeOutPeriod = 6000; // 6 sec.\r\n\r\n    #timerId = null;\r\n\r\n    #inited = false;\r\n\r\n    init() {\r\n        if (this.#inited) {\r\n            return;\r\n        }\r\n\r\n        this.#inited = true;\r\n\r\n        if (this.mode !== 'production') {\r\n            console.log('init ServerEventsAjaxDriver ', this.eventsUrl);\r\n        }\r\n\r\n        this.#timerId = setTimeout(() => this.#getEvents(), 500);\r\n    }\r\n\r\n    async #getEvents() {\r\n        try {\r\n            const url = this.eventsUrl + '&ts=' + Date.now();\r\n            const response = await fetch(url);\r\n            if (!response.ok) {\r\n                throw new Error(`Response status: ${response.status}`);\r\n            }\r\n\r\n            const result = await response.json();\r\n\r\n            if (result.error !== undefined) {\r\n                if (result.error.code === 'driverDisabled') {\r\n                    if (this.mode !== 'production') {\r\n                        console.error(result.error.message);\r\n                    }\r\n                    // Do not send more requests\r\n                    return;\r\n                }\r\n            }\r\n\r\n            if (result.events !== undefined) {\r\n                result.events.forEach((event) => {\r\n                    event.eventId = event.id !== undefined ? event.id : null;\r\n                    this.onEventTriggered(event);\r\n                });\r\n            }\r\n\r\n            this.#timerId = setTimeout(() => this.#getEvents(), this.#timeOutPeriod);\r\n        } catch (error) {\r\n            console.error('ServerEventsAjaxDriver get events error: ' + error.message);\r\n            this.#timerId = setTimeout(() => this.#getEvents(), this.#timeOutPeriod);\r\n        }\r\n    }\r\n}","import {ServerEventsSSEDriver} from \"./ServerEventsSSEDriver\";\r\nimport {ServerEventsAjaxDriver} from \"./ServerEventsAjaxDriver\";\r\n\r\n/**\r\n * Base server events driver\r\n * @package Cotonti\r\n * @copyright (c) Cotonti Team\r\n */\r\nexport class ServerEventsDriverFactory {\r\n    #baseUrl = '/';\r\n\r\n    #mode = 'production'\r\n\r\n    constructor(baseUrl = null, mode = null) {\r\n        if (baseUrl !== null) {\r\n            this.#baseUrl = baseUrl;\r\n        }\r\n        if (mode !== null) {\r\n            this.#mode = mode;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param {string} driverType\r\n     * @returns {ServerEventsSSEDriver|ServerEventsAjaxDriver}\r\n     */\r\n    getByType(driverType) {\r\n        let driver = null;\r\n\r\n        const serverSentEventsUrl = this.#baseUrl + '?n=server-events&a=sse';\r\n        const ajaxEventsUrl = this.#baseUrl + '?n=server-events&a=ajax&_ajax=1';\r\n\r\n        switch (driverType) {\r\n            case 'sse':\r\n                // Server-Sent events driver\r\n                driver = new ServerEventsSSEDriver(serverSentEventsUrl, this.#mode);\r\n                if (this.#mode !== 'production') {\r\n                    console.log('using ServerEventsSSEDriver', serverSentEventsUrl);\r\n                }\r\n                break;\r\n\r\n            default:\r\n                driver = new ServerEventsAjaxDriver(ajaxEventsUrl, this.#mode);\r\n                if (this.#mode !== 'production') {\r\n                    console.log('using ServerEventsAjaxDriver', ajaxEventsUrl);\r\n                }\r\n        }\r\n\r\n        return driver;\r\n    }\r\n}","import {ServerEventsDriverFactory} from \"./driver/ServerEventsDriverFactory\";\r\n\r\n/**\r\n * Shared worker for Server Sent Events\r\n * @package Cotonti\r\n * @copyright (c) Cotonti Team\r\n * @link https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events\r\n */\r\nclass ServerSentEvents {\r\n    /**\r\n     * @type {ServerEventsAjaxDriver|ServerEventsSSEDriver|null}\r\n     */\r\n    #driver = null;\r\n\r\n    /**\r\n     * @type {string|null}\r\n     */\r\n    #usingDriverType = null;\r\n\r\n    /**\r\n     * @type {string|null}\r\n     */\r\n    mode = 'production';\r\n\r\n    /**\r\n     * @type {string|null}\r\n     */\r\n    driverType = null;\r\n\r\n    /**\r\n     * @type {string}\r\n     */\r\n    baseUrl = '/';\r\n\r\n    /**\r\n     * @type {function|null}\r\n     */\r\n    onEvent = null;\r\n\r\n    #initialisationInProgress = false;\r\n\r\n    /**\r\n     * @todo Save the initialized driverType.\r\n     * When changing the driver type, remove the old one and initialize the new one.\r\n     * This may be unnecessary, but it could be useful during configuration.\r\n     */\r\n    init() {\r\n        if (this.mode !== 'production') {\r\n            console.log('Shared worker: ');\r\n            console.log('Running driver: ', this.#usingDriverType);\r\n            console.log('New driver: ', this.driverType);\r\n        }\r\n\r\n        if (this.#usingDriverType === this.driverType) {\r\n            if (this.mode !== 'production') {\r\n                console.log('Shared worker: драйвер \"' + this.#usingDriverType, + '\"уже инициализирован. действий не требуется');\r\n            }\r\n            return\r\n        }\r\n\r\n        if (this.#initialisationInProgress) {\r\n            return;\r\n        }\r\n\r\n        this.#initialisationInProgress = true;\r\n\r\n        if (this.mode !== 'production') {\r\n            console.log('Shared worker: ServerSentEvents initialization.');\r\n        }\r\n\r\n        if (this.#driver !== null) {\r\n            if (this.mode !== 'production') {\r\n                console.log('Shared worker: отключаем старый драйвер: ', this.#usingDriverType);\r\n            }\r\n            this.#driver = null;\r\n        }\r\n\r\n        try {\r\n            const factory = new ServerEventsDriverFactory(this.baseUrl, this.mode);\r\n\r\n            this.#driver = factory.getByType(this.driverType);\r\n            this.#usingDriverType = this.driverType;\r\n\r\n            this.#driver.addEventListener('event', (event) => {\r\n                if (typeof this.onEvent !== 'function') {\r\n                    console.error(this.constructor.name + '.onEvent is not defined');\r\n                }\r\n                this.onEvent(event.detail);\r\n            });\r\n            this.#driver.init();\r\n        } catch (error) {\r\n            console.error(error);\r\n        }\r\n\r\n        this.#initialisationInProgress = false;\r\n    }\r\n}\r\n\r\n/**\r\n * @type {MessagePort[]}\r\n */\r\nconst ports = [];\r\n\r\n/**\r\n * @type {ServerSentEvents|null}\r\n */\r\nlet events = null;\r\n\r\nself.onconnect = (event) => {\r\n    const port = event.ports[0];\r\n\r\n    ports.push(port);\r\n\r\n    if (events === null) {\r\n        events = new ServerSentEvents();\r\n        events.onEvent = (event) => {\r\n            if (events.mode !== 'production') {\r\n                console.log('Shared worker postMessage', event);\r\n            }\r\n\r\n            for (const client of ports) {\r\n                client.postMessage(event);\r\n            }\r\n        }\r\n    }\r\n\r\n    port.onmessage = (e) => {\r\n        const message = e.data;\r\n\r\n        if (events.mode !== 'production') {\r\n            console.log('Shared worker message', message);\r\n        }\r\n\r\n        if (message.config !== undefined) {\r\n            if (events.driverType !== message.config.driver) {\r\n                events.driverType = message.config.driver;\r\n                events.mode = message.config.mode;\r\n                events.baseUrl = message.config.baseUrl;\r\n                events.init();\r\n            }\r\n        }\r\n    }\r\n}\r\n"],"names":["BaseServerEventsDriver","EventTarget","mode","eventsUrl","constructor","super","this","init","onEventTriggered","eventData","console","log","event","CustomEvent","detail","dispatchEvent","ServerEventsSSEDriver","url","Date","now","EventSource","onopen","onmessage","JSON","parse","data","undefined","eventId","lastEventId","onerror","ServerEventsAjaxDriver","setTimeout","response","fetch","ok","Error","status","result","json","error","code","message","events","forEach","id","ServerEventsDriverFactory","baseUrl","getByType","driverType","driver","serverSentEventsUrl","ajaxEventsUrl","ServerSentEvents","onEvent","factory","addEventListener","name","ports","self","onconnect","port","push","client","postMessage","e","config"],"sourceRoot":""}